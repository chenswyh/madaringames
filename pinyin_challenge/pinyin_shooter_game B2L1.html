<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pinyin Challenge — Play</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#0f1220;--text:#e6e9f2;--accent:#3dd6d0;--danger:#ff5c7a;}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text);}
body{overflow:hidden;}
canvas{display:block;width:100%;height:calc(100vh - 40px);}
#inputUI{
  position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
  background: rgba(61,214,208,0.15); font-weight: 700; font-size: 22px;
  padding: 10px 18px; border-radius: 12px; border: 1px solid rgba(61,214,208,0.5);
  min-width: 260px; text-align: center; box-shadow: 0 4px 16px rgba(61,214,208,0.3); letter-spacing:1px;
}
#inputUI span.correct{color:#3dd6d0;}
#inputUI span.wrong{color:#ff5c7a;}
#inputUI span.neutral{color:#e6e9f2;}
.modal{
  position: fixed; top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.85); color:#e6e9f2; display:flex; flex-direction:column; justify-content:center; align-items:center;
  z-index: 9999; font-family: Inter; padding:20px;
}
#vocabSearch{margin-bottom:10px; padding:6px; width:80%; border-radius:6px; border:none;}
#vocabScroll{max-height:70vh; overflow-y:auto; width:100%; margin-bottom:12px;}
#vocabScroll table{width:100%; border-collapse: collapse;}
#vocabScroll th, #vocabScroll td{padding:4px 8px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.08);}
#vocabScroll.compact th, #vocabScroll.compact td{padding:2px 6px;}
#countdown{font-size:48px;font-weight:800;margin:12px;color:#ffd166; display:none;}
button{background:var(--accent);border:none;padding:10px 18px;border-radius:10px;color:#0e111a;font-weight:700;cursor:pointer;}
button:hover{opacity:0.9;}
#musicToggle{
  position:fixed; top:15px; right:15px; background:rgba(61,214,208,0.15);
  border:1px solid rgba(61,214,208,0.5); padding:6px 10px; border-radius:8px;
  cursor:pointer; color:#3dd6d0; z-index:5000;
}
#leaderboard{margin-top:15px; max-height:200px; overflow-y:auto;}
#leaderboard table{width:100%; border-collapse:collapse;}
#leaderboard th, #leaderboard td{padding:4px 6px; border-bottom:1px solid rgba(255,255,255,0.1);}
</style>
</head>
<body>
<canvas id="game" aria-label="pinyin challenge"></canvas>
<div id="inputUI"></div>
<button id="musicToggle">🔇</button>

<!-- Main Menu -->
<div id="mainMenu" class="modal">
  <h1>Pinyin Challenge</h1>
  <button id="mainStart">Start Game</button>
</div>

<!-- Review Modal -->
<div id="reviewModal" class="modal" style="display:none;">
  <h2>Review Vocabulary</h2>
  <input id="vocabSearch" placeholder="Search words..."/>
  <div id="vocabScroll">
    <table>
      <thead><tr><th>Hanzi</th><th>Pinyin</th><th>Meaning</th></tr></thead>
      <tbody id="vocabTable"></tbody>
    </table>
  </div>
  <label style="margin:8px;">
    <input type="checkbox" id="musicChoice"/> Enable background music
  </label>
  <div id="countdown">3</div>
  <button id="startBtn">Start Game</button>
</div>

<!-- Game Over Modal -->
<div id="gameOverModal" class="modal" style="display:none;">
  <h2>Game Over</h2>
  <p id="finalScore"></p>
  <input id="playerName" placeholder="Enter initials" maxlength="3" style="text-transform:uppercase; text-align:center; padding:6px; margin:10px;"/>
  <div>
    <button id="playAgain">Play Again</button>
    <button id="exitGame">Exit</button>
  </div>
  <div id="leaderboard">
    <h3>Leaderboard</h3>
    <table>
      <thead><tr><th>#</th><th>Name</th><th>Score</th><th></th></tr></thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
  </div>
</div>

<audio id="bgMusic" src="audio/bg.mp3" loop></audio>

<script>
const VOCAB = [{"hanzi":"天氣","pinyin":"tian1qi4","meaning":"weather"},{"hanzi":"這裡","pinyin":"zhe4li3","meaning":"here"},{"hanzi":"真","pinyin":"zhen1","meaning":"really / truly"},{"hanzi":"舒服","pinyin":"shu1fu2","meaning":"comfortable"},{"hanzi":"比","pinyin":"bi3","meaning":"compare / than"},{"hanzi":"春天","pinyin":"chun1tian1","meaning":"spring"},{"hanzi":"秋天","pinyin":"qiu1tian1","meaning":"autumn / fall"},{"hanzi":"冷","pinyin":"leng3","meaning":"cold"},{"hanzi":"熱","pinyin":"re4","meaning":"hot"},{"hanzi":"冬天","pinyin":"dong1tian1","meaning":"winter"},{"hanzi":"太","pinyin":"tai4","meaning":"too / very"},{"hanzi":"時候","pinyin":"shi2hou4","meaning":"time / moment"},{"hanzi":"麻煩","pinyin":"ma2fan2","meaning":"troublesome / to bother / please (polite request)"},{"hanzi":"對","pinyin":"dui4","meaning":"correct / right / towards"},{"hanzi":"能","pinyin":"neng2","meaning":"can / be able to"},{"hanzi":"出來","pinyin":"chu1lai2","meaning":"to come out"},{"hanzi":"可能","pinyin":"ke3neng2","meaning":"possible / maybe"},{"hanzi":"會","pinyin":"hui4","meaning":"can / will / to know how to"},{"hanzi":"希望","pinyin":"xi1wang4","meaning":"to hope / hope"},{"hanzi":"晴天","pinyin":"qing2tian1","meaning":"sunny day"},{"hanzi":"下雪","pinyin":"xia4 xue3","meaning":"to snow"},{"hanzi":"下雨","pinyin":"xia4 yu3","meaning":"to rain"},{"hanzi":"天氣預報","pinyin":"tian1qi4 yu4bao4","meaning":"weather forecast"},{"hanzi":"昨天","pinyin":"zuo2tian1","meaning":"yesterday"},{"hanzi":"給","pinyin":"gei3","meaning":"to give / for (someone)"},{"hanzi":"一定","pinyin":"yi2ding4","meaning":"definitely / surely"}];
const OPTS = {"lives":5,"baseSpeed":0.5,"difficulty":"beginner","letPlayerChooseTone":false,"useBgImage":false,"bgColor":"#0f1220","ptsCorrect":10,"ptsWrong":5,"streakNeeded":5,"freezeMs":3500};
const LEADER_KEY = 'PINYIN_CHALLENGE_LEADERBOARD_V1';

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let dpr = Math.max(1, window.devicePixelRatio||1);
function resize(){ 
  canvas.width = Math.round(window.innerWidth*dpr); 
  canvas.height = Math.round(window.innerHeight*dpr); 
  canvas.style.width = window.innerWidth + 'px'; 
  canvas.style.height = window.innerHeight + 'px'; 
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener('resize', resize);
resize();

const inputUI = document.getElementById('inputUI');
let inputBuffer = '';

const bgMusic = document.getElementById('bgMusic');
const musicToggle = document.getElementById('musicToggle');
let musicMuted=true; // default off
musicToggle.textContent='🔇';
musicToggle.addEventListener('click', ()=>{
  musicMuted=!musicMuted;
  if(musicMuted){ bgMusic.pause(); musicToggle.textContent='🔇'; }
  else { bgMusic.play(); musicToggle.textContent='🔊'; }
});

/* ---------------------- Leaderboard ---------------------- */
function loadLeaderboard(){ try { return JSON.parse(localStorage.getItem(LEADER_KEY))||[] } catch(e){ return [] } }
function saveLeaderboard(list){ localStorage.setItem(LEADER_KEY, JSON.stringify(list.slice(0,50))) }
function addLeaderboard(name, score){ 
  const l = loadLeaderboard(); 
  l.push({name:name.slice(0,3).toUpperCase(),score,when:Date.now()}); 
  l.sort((a,b)=>b.score-a.score); 
  saveLeaderboard(l); 
}
function renderLeaderboard(){
  const lb=loadLeaderboard();
  const body=document.getElementById('leaderboardBody');
  body.innerHTML='';
  lb.forEach((r,i)=>{
    const tr=document.createElement('tr');
    const date=new Date(r.when); 
    tr.innerHTML='<td>'+(i+1)+'</td><td>'+r.name+'</td><td>'+r.score+'</td>';
    body.appendChild(tr);
  });
}

/* ---------------------- Game State ---------------------- */
const BASE_W = 960, BASE_H = 640;
let state = {};
let spawnAcc=0, last=performance.now();

function normalized(s,mode){ if(!s) return ''; s=(''+s).toLowerCase().trim(); if(mode==='no-tones') return s.replace(/[1-5]/g,'').replace(/\s+/g,''); return s.replace(/\s+/g,''); }

/* ---------------------- Modals ---------------------- */
const mainMenu = document.getElementById('mainMenu');
const reviewModal = document.getElementById('reviewModal');
const vocabTable = document.getElementById('vocabTable');
const vocabScroll = document.getElementById('vocabScroll');
const vocabSearch = document.getElementById('vocabSearch');
const countdownEl = document.getElementById('countdown');
const startBtn = document.getElementById('startBtn');
const gameOverModal = document.getElementById('gameOverModal');
const finalScoreEl = document.getElementById('finalScore');
const playerNameEl = document.getElementById('playerName');
const musicChoice=document.getElementById('musicChoice');

function renderVocab(filter=""){
  vocabTable.innerHTML='';
  const filtered=VOCAB.filter(w=>{
    const f=filter.toLowerCase();
    return !f||w.hanzi.includes(f)||w.pinyin.toLowerCase().includes(f)||w.meaning.toLowerCase().includes(f);
  });
  filtered.forEach(w=>{
    const tr = document.createElement('tr');
    tr.innerHTML = '<td>'+w.hanzi+'</td><td>'+w.pinyin+'</td><td>'+w.meaning+'</td>';
    vocabTable.appendChild(tr);
  });
  if(filtered.length>15){ vocabScroll.classList.add('compact'); }
  else { vocabScroll.classList.remove('compact'); }
}
vocabSearch.addEventListener('input',()=>renderVocab(vocabSearch.value));

document.getElementById('mainStart').addEventListener('click', ()=>{
  mainMenu.style.display='none';
  reviewModal.style.display='flex';
  renderVocab();
});

startBtn.addEventListener('click', ()=>{
  let count = 3;
  countdownEl.textContent = count;
  countdownEl.style.display='block';
  const interval = setInterval(()=>{
    count--;
    countdownEl.textContent = count;
    if(count===0){
      clearInterval(interval);
      countdownEl.style.display='none';
      reviewModal.style.display='none';
      musicMuted=!musicChoice.checked;
      initGame();
    }
  },1000);
});

/* ---------------------- Game Engine ---------------------- */
function initGame(){
  state = {
    screen:'playing',
    items:[],
    score:0,
    lives: OPTS.lives||3,
    streak:0,
    speedBase: OPTS.baseSpeed||2,
    speedMul:1,
    adaptive:{correct:0,missed:0},
    toneMode: OPTS.difficulty==='beginner'?'no-tones':'tones'
  };
  inputBuffer='';
  spawnAcc=0;
  last=performance.now();
  if(!musicMuted){ bgMusic.currentTime=0; bgMusic.play(); musicToggle.textContent='🔊'; }
  else{ musicToggle.textContent='🔇'; }
  requestAnimationFrame(gameLoop);
}

function spawnWord(){
  const w = {...VOCAB[Math.floor(Math.random()*VOCAB.length)]};
  w.x = Math.random()*(BASE_W-120)+60;
  w.y=-20;
  w.speed = Math.min(0.5,(state.speedBase + Math.random()*1.2)*state.speedMul);
  state.items.push(w);
}

function updateAdaptive(){
  const cf = 1 + Math.min(1.2,state.adaptive.correct/Math.max(1,VOCAB.length));
  const mf = 1 - Math.min(0.5,state.adaptive.missed/Math.max(1,VOCAB.length)*0.6);
  state.speedMul = Math.max(0.6, Math.min(2.4, cf*mf));
}

function renderInput(){
  if(!inputBuffer){ inputUI.textContent=''; return; }
  const mode = state.toneMode;
  const norm = normalized(inputBuffer, mode);
  let anyMatch=false;
  for(const w of state.items){
    if(normalized(w.pinyin, mode).startsWith(norm)){ anyMatch=true; break; }
  }
  inputUI.innerHTML='';
  for(let i=0;i<inputBuffer.length;i++){
    const span=document.createElement('span');
    span.textContent=inputBuffer[i];
    if(anyMatch){ span.className='correct'; }
    else { span.className='wrong'; }
    inputUI.appendChild(span);
  }
}

function gameLoop(now){
  const dt=(now-last)/1000; last=now;
  spawnAcc+=dt;
//  if(spawnAcc>Math.max(0.45,1.15/state.speedMul)){ spawnWord(); spawnAcc=0; }
if(spawnAcc>Math.max(0.85,1.15/state.speedMul)){ spawnWord(); spawnAcc=0; }

  for(let i=state.items.length-1;i>=0;i--){
    const it=state.items[i];
    it.y+=it.speed*dt*60;
    if(it.y>=BASE_H-60){
      state.items.splice(i,1); state.lives--; state.streak=0; state.adaptive.missed++; updateAdaptive();
    }
  }

  ctx.fillStyle=OPTS.bgColor||'#0f1220'; ctx.fillRect(0,0,canvas.width/dpr,canvas.height/dpr);
  ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillStyle='#fff'; ctx.font='700 42px Inter';
  state.items.forEach(it=>ctx.fillText(it.hanzi,it.x*canvas.width/(BASE_W*dpr),it.y*canvas.height/(BASE_H*dpr)));

  renderInput();

  ctx.textAlign='center'; ctx.fillStyle='#e6e9f2'; ctx.font='600 16px Inter';
  ctx.fillText('Score: '+state.score+' • Lives: '+state.lives+' • Streak: '+state.streak, canvas.width/(2*dpr), 40);

  if(state.lives<=0){ endGame(); return; }
  requestAnimationFrame(gameLoop);
}

/* ---------------------- Input ---------------------- */
window.onkeydown=(e)=>{
  if(state.screen!=='playing') return;
  if(e.key==='Backspace'){ inputBuffer=inputBuffer.slice(0,-1); renderInput(); e.preventDefault(); }
  else if(e.key==='Enter'){
    const val=normalized(inputBuffer,state.toneMode);
    if(!val){ inputBuffer=''; renderInput(); return; }
    let cleared=0;
    for(let i=state.items.length-1;i>=0;i--){
      const it=state.items[i];
      if(normalized(it.pinyin,state.toneMode)===val){ state.items.splice(i,1); cleared++; }
    }
    if(cleared>0){
      state.score+=(OPTS.ptsCorrect||10)*cleared; state.streak+=cleared; state.adaptive.correct+=cleared;
    } else {
      state.score=Math.max(0,state.score-(OPTS.ptsWrong||5)); state.streak=0; state.adaptive.missed++;
    }
    updateAdaptive(); inputBuffer=''; renderInput();
  } else if(e.key.length===1){ inputBuffer+=e.key; renderInput(); }
};

/* ---------------------- Game Over ---------------------- */
function endGame(){
  state.screen='gameover'; bgMusic.pause();
  finalScoreEl.textContent='Final Score: '+state.score;
  renderLeaderboard();
  gameOverModal.style.display='flex';
}

document.getElementById('playAgain').addEventListener('click', ()=>{
  const name = playerNameEl.value||'AAA'; addLeaderboard(name,state.score);
  playerNameEl.value='';
  gameOverModal.style.display='none';
  reviewModal.style.display='flex';
  renderVocab();
});

document.getElementById('exitGame').addEventListener('click', ()=>{
  const name = playerNameEl.value||'AAA'; addLeaderboard(name,state.score);
  playerNameEl.value='';
  gameOverModal.style.display='none';
  mainMenu.style.display='flex';
});
</script>
</body>
</html>